#!/usr/bin/env bash
# === MERKLE-MORPH GITHOOK ===
#
# Verify what is about to be committed. Called by "git commit" with no
# arguments. The hook should exit with non-zero status after issuing an
# appropriate message if it wants to stop the commit.

if git rev-parse --verify HEAD >/dev/null 2>&1
then
	against=HEAD
else
	# Initial commit: diff against an empty tree object
	against=$(git hash-object -t tree /dev/null)
fi

# If you want to allow non-ASCII filenames set this variable to true.
allownonascii=$(git config --bool hooks.allownonascii)

# Redirect output to stderr.
exec 1>&2

# Cross platform projects tend to avoid non-ASCII filenames; prevent
# them from being added to the repository. We exploit the fact that the
# printable range starts at the space character and ends with tilde.
if [ "$allownonascii" != "true" ]; then
	# Check for non-ASCII filenames in newly added files
	# Use a temp file to collect problematic files (since subshells can't set parent vars)
	tmpfile=$(mktemp)
	trap "rm -f '$tmpfile'" EXIT

	git diff --cached --name-only --diff-filter=A -z "$against" |
		while IFS= read -r -d '' file; do
			if [ -n "$file" ]; then
				# Check both filename and directory path
				if echo "$file" | LC_ALL=C grep -q '[^ -~]'; then
					echo "$file" >> "$tmpfile"
				fi
			fi
		done

	if [ -s "$tmpfile" ]; then
		echo "Error: Attempt to add files with non-ASCII characters in their names:"
		echo ""
		while IFS= read -r file; do
			echo "  $file"
		done < "$tmpfile"
		echo ""
		echo "This can cause problems if you want to work with people on other platforms."
		echo "To be portable it is advisable to rename the file(s)."
		echo ""
		echo "If you know what you are doing you can disable this check using:"
		echo ""
		echo "  git config hooks.allownonascii true"
		exit 1
	fi
fi

# If there are whitespace errors, print the offending file names and fail.
git diff-index --check --cached "$against" -- || exit 1

# Auto-format code before committing.
REPO_DIR=$(git rev-parse --show-toplevel)
cd "$REPO_DIR"

# Get list of staged Rust files before formatting (for re-staging after format)
staged_rust_files=$(git diff --cached --name-only --diff-filter=ACM "$against" | grep '\.rs$' || true)

# Format the code using justfile recipe
if [ -n "$staged_rust_files" ]; then
	just fmt || {
		echo "Error: Formatting failed."
		exit 1
	}
	# Re-stage any files that were formatted
	while IFS= read -r file; do
		if [ -n "$file" ] && [ -f "$file" ]; then
			git add "$file" 2>/dev/null || true
		fi
	done <<EOF
$staged_rust_files
EOF
fi

# Check that code lints cleanly (only on Rust files being committed).
rust_files=$(git diff --cached --name-only --diff-filter=ACM "$against" | grep '\.rs$' || true)
if [ -n "$rust_files" ]; then
	just lint || {
		echo "Error: Clippy found warnings. Fix them before committing."
		exit 1
	}
fi

# Check for broken links throughout the repository.
just link-check || {
	echo "Error: Broken links found. Fix them before committing."
	exit 1
}
